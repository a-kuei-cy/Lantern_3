<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® å…ƒå®µç¯€é›™èªçŒœç‡ˆè¬å¤§æœƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .lantern-shadow { box-shadow: 0 0 50px rgba(255, 200, 0, 0.6); }
        .animate-bounce-slow { animation: bounce 3s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(-5%); } 50% { transform: translateY(5%); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-red-900 text-gray-100 min-h-screen overflow-hidden relative selection:bg-yellow-500 selection:text-red-900">

    <!-- è£é£¾ -->
    <div class="absolute top-0 left-8 w-20 h-32 bg-red-600 rounded-b-3xl opacity-90 border-t-8 border-yellow-600 z-0 flex items-center justify-center animate-bounce-slow lantern-shadow">
        <span class="text-yellow-300 text-4xl font-serif font-bold opacity-60 mt-4">æ˜¥</span>
    </div>
    <div class="absolute top-0 right-8 w-20 h-32 bg-red-600 rounded-b-3xl opacity-90 border-t-8 border-yellow-600 z-0 flex items-center justify-center animate-bounce-slow lantern-shadow" style="animation-delay: 1.5s;">
        <span class="text-yellow-300 text-4xl font-serif font-bold opacity-60 mt-4">ç¦</span>
    </div>

    <!-- App å®¹å™¨ -->
    <div id="app" class="relative z-10 container mx-auto px-4 py-4 max-w-6xl h-screen flex flex-col">
        <nav class="flex justify-between items-center mb-4 bg-black/30 p-3 rounded-2xl backdrop-blur-md border border-white/10 z-50">
            <div class="flex items-center gap-2">
                <div id="status-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-600 text-gray-300 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-current animate-pulse"></span>
                    <span id="status-text">é€£ç·šä¸­...</span>
                </div>
            </div>
            <div class="flex gap-2 text-xs">
                <button onclick="router('welcome')" class="border border-white/20 px-3 py-1 rounded hover:bg-white hover:text-red-900 transition">é¦–é </button>
                <button onclick="router('dashboard')" class="border border-white/20 px-3 py-1 rounded hover:bg-white hover:text-red-900 transition">å¤§è¢å¹•</button>
                <button onclick="router('admin')" class="bg-yellow-600 text-black px-3 py-1 rounded font-bold hover:bg-yellow-500 transition">å¾Œå°</button>
            </div>
        </nav>

        <main id="view-container" class="flex-grow flex flex-col relative w-full overflow-hidden"></main>
    </div>

    <script>
        // ==========================================
        // âš™ï¸ Google Apps Script API ç¶²å€ (å·²ç¶å®š)
        // ==========================================
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxOiHFTrGIgUKCOhStPgFG9tq-gWO8aDaVyVoqNaMD2tFPO8U6i7nBdrGpky8Wt4wr1Eg/exec';

        // ğŸ“ å…§å»º 40 é“é›™èªé¡Œåº«
        const BUILT_IN_RIDDLES = [
            { cn: "æœ‰é ­æ²’æœ‰é ¸ï¼Œèº«ä¸Šå†·å†°å†°ï¼Œæœ‰ç¿…ä¸èƒ½é£›ï¼Œç„¡è…³ä¹Ÿèƒ½è¡Œã€‚", en: "Has a head but no neck, feels ice cold, has wings but can't fly, no legs but can move.", ans: "é­š (Fish)", opts: ["é­š (Fish)", "è›‡ (Snake)", "é³¥ (Bird)", "çƒé¾œ (Turtle)"] },
            { cn: "å¹´ç´€ä¸¦ä¸å¤§ï¼Œé¬å­ä¸€å¤§æŠŠï¼Œä¸ç®¡è¦‹åˆ°èª°ï¼Œç¸½æ„›å«åª½åª½ã€‚", en: "Not old, but has a long beard, calls everyone 'mom'.", ans: "ç¾Š (Goat)", opts: ["è²“ (Cat)", "ç¾Š (Goat)", "ç‹— (Dog)", "è€é¼  (Mouse)"] },
            { cn: "é ­æˆ´ç´…å¸½å­ï¼Œèº«ç©¿ç™½è¢å­ï¼Œèµ°è·¯æ“ºæ¶å­ï¼Œèªªè©±ä¼¸è„–å­ã€‚", en: "Wears a red hat and white robe, walks with a swagger, stretches its neck when talking.", ans: "éµ (Goose)", opts: ["é› (Chicken)", "é´¨ (Duck)", "éµ (Goose)", "å­”é›€ (Peacock)"] },
            { cn: "è€³æœµåƒè’²æ‰‡ï¼Œèº«å­åƒå°å±±ï¼Œé¼»å­é•·åˆé•·ï¼Œå¹«äººæŠŠæ´»å¹¹ã€‚", en: "Ears like fans, body like a hill, nose is very long, helps people work.", ans: "å¤§è±¡ (Elephant)", opts: ["ç‰› (Cow)", "å¤§è±¡ (Elephant)", "é¦¬ (Horse)", "çŠ€ç‰› (Rhino)"] },
            { cn: "èº«ç©¿æ¢…èŠ±è¢ï¼Œé ­ä¸Šé ‚é£›åˆ€ï¼Œç§‹å¤©è½è‘‰é£„ï¼Œå±±è£¡è·‘å¾—è·‘ã€‚", en: "Wears a plum blossom robe, has flying knives on its head, runs in the mountains in autumn.", ans: "æ¢…èŠ±é¹¿ (Deer)", opts: ["è€è™ (Tiger)", "æ¢…èŠ±é¹¿ (Deer)", "è±¹ (Leopard)", "ç‹ç‹¸ (Fox)"] },
            { cn: "å…„å¼Ÿä¸ƒå…«å€‹ï¼Œåœè‘—æŸ±å­åï¼Œå¤§å®¶ä¸€åˆ†æ‰‹ï¼Œè¡£æœå°±æ‰¯ç ´ã€‚", en: "Seven or eight brothers sitting around a pillar, when they part, their clothes tear.", ans: "å¤§è’œ (Garlic)", opts: ["æ´‹è”¥ (Onion)", "å¤§è’œ (Garlic)", "è˜‹æœ (Apple)", "æ©˜å­ (Orange)"] },
            { cn: "é»ƒåŒ…è¢±ï¼ŒåŒ…é»‘è±†ï¼Œå˜—ä¸€å£ï¼Œç”œæ°´æµã€‚", en: "Yellow bundle, wrapped black beans, take a bite, sweet water flows.", ans: "æœ¨ç“œ (Papaya)", opts: ["é¦™è•‰ (Banana)", "è¥¿ç“œ (Watermelon)", "æœ¨ç“œ (Papaya)", "èŠ’æœ (Mango)"] },
            { cn: "ç´…é—œå…¬ï¼Œç™½åŠ‰å‚™ï¼Œé»‘å¼µé£›ï¼Œåƒç–åœ¨ä¸€å¡Šã€‚", en: "Red Guan Yu, White Liu Bei, Black Zhang Fei, all together.", ans: "è”æ (Lychee)", opts: ["è˜‹æœ (Apple)", "è‘¡è„ (Grape)", "è”æ (Lychee)", "æ°´èœœæ¡ƒ (Peach)"] },
            { cn: "ç”Ÿåœ¨æ¨¹ä¸Šæ˜¯é’çš„ï¼Œè½åˆ°åœ°ä¸Šæ˜¯é»ƒçš„ï¼Œä¸ç”¨åˆ€å‰Šæ˜¯åœ“çš„ï¼Œä¸åŠ ç³–èœœæ˜¯ç”œçš„ã€‚", en: "Green on the tree, yellow on the ground, round without peeling, sweet without sugar.", ans: "æ¡‚åœ“ (Longan)", opts: ["è”æ (Lychee)", "æ¡‚åœ“ (Longan)", "è˜‹æœ (Apple)", "é¦™è•‰ (Banana)"] },
            { cn: "å°å°ç´…å£‡å­ï¼Œè£æ»¿ç´…é¤ƒå­ï¼Œåƒæ‰ç´…é¤ƒå­ï¼Œåå‡ºç™½ç å­ã€‚", en: "Small red jar filled with red dumplings, eat the red dumplings, spit out white beads.", ans: "æ©˜å­ (Orange)", opts: ["è˜‹æœ (Apple)", "æ©˜å­ (Orange)", "è‰è“ (Strawberry)", "æ«»æ¡ƒ (Cherry)"] },
            { cn: "æœ‰é¢æ²’æœ‰å£ï¼Œæœ‰è…³æ²’æœ‰æ‰‹ï¼Œé›–æœ‰å››éš»è…³ï¼Œè‡ªå·±ä¸æœƒèµ°ã€‚", en: "Has a face but no mouth, has legs but no hands, has four legs but can't walk.", ans: "æ¡Œå­ (Table)", opts: ["æ¤…å­ (Chair)", "åºŠ (Bed)", "æ¡Œå­ (Table)", "æ«ƒå­ (Cabinet)"] },
            { cn: "ç™½ç™½ä¸€ç‰‡ä¼¼é›ªèŠ±ï¼Œè½ä¸‹æ°´è£¡ä¸è¦‹å®ƒï¼Œå–®ç¨åƒå®ƒæœƒçšºçœ‰ï¼Œä¸åƒå®ƒæ™‚æ·¡ç„¡å‘³ã€‚", en: "White like snowflake, disappears in water, tastes sour alone, tasteless without it.", ans: "é¹½ (Salt)", opts: ["ç³– (Sugar)", "éºµç²‰ (Flour)", "é¹½ (Salt)", "å‘³ç²¾ (MSG)"] },
            { cn: "èº«ç©¿èŠ±è¡£è£³ï¼Œå€‹å­ç´°åˆé•·ã€‚å¯«å­—åˆç•«ç•«ï¼Œè¶Šé•·è¶Šè®ŠçŸ­ã€‚", en: "Wears colorful clothes, tall and thin. Writes and draws, gets shorter as it grows.", ans: "é‰›ç­† (Pencil)", opts: ["é‰›ç­† (Pencil)", "æ©¡çš®æ“¦ (Eraser)", "å°º (Ruler)", "å‰ªåˆ€ (Scissors)"] },
            { cn: "æœ‰å˜´ä¸èƒ½èªªè©±ï¼Œæœ‰è‚šå­ä¸åƒæ±è¥¿ï¼Œæ¯å¤©å–æ°´å¾ˆå¤šï¼Œå»ä¸é•·ä¸€å¡Šè‚‰ã€‚", en: "Has a mouth but can't speak, has a belly but doesn't eat, drinks lots of water but doesn't gain weight.", ans: "èŒ¶å£º (Teapot)", opts: ["æ°´æ¯ (Cup)", "èŒ¶å£º (Teapot)", "èŠ±ç“¶ (Vase)", "ç¢— (Bowl)"] },
            { cn: "å››å››æ–¹æ–¹ä¸€å¡Šå¸ƒï¼Œå˜´å’Œé¼»å­éƒ½è“‹ä½ï¼Œå…©æ ¹å¸¶å­è€³ä¸Šæ›ï¼Œä¸æ€•é¢¨æ²™ä¸æ€•åœŸã€‚", en: "Square piece of cloth, covers mouth and nose, strings on ears, not afraid of dust.", ans: "å£ç½© (Mask)", opts: ["å¸½å­ (Hat)", "åœå·¾ (Scarf)", "å£ç½© (Mask)", "æ‰‹å¥— (Glove)"] },
            { cn: "æœ‰æ™‚åœ“åœ“åƒå€‹ç›¤å­ï¼Œæœ‰æ™‚å½å½åƒéš»èˆ¹ï¼Œç™½å¤©çœ‹ä¸è¦‹ï¼Œæ™šä¸Šæ‰å‡ºä¾†ã€‚", en: "Sometimes round like a plate, sometimes curved like a boat, invisible by day, comes out at night.", ans: "æœˆäº® (Moon)", opts: ["å¤ªé™½ (Sun)", "æ˜Ÿæ˜Ÿ (Star)", "æœˆäº® (Moon)", "é›²å½© (Cloud)"] },
            { cn: "åƒæ ¹ç·šï¼Œè¬æ ¹ç·šï¼Œæ‰åˆ°æ°´è£¡çœ‹ä¸è¦‹ã€‚", en: "Thousands of threads, fall into the water and disappear.", ans: "é›¨ (Rain)", opts: ["é›ª (Snow)", "é¢¨ (Wind)", "é›¨ (Rain)", "å†° (Ice)"] },
            { cn: "çœ‹ä¸è¦‹ï¼Œæ‘¸ä¸åˆ°ï¼Œå››é¢å…«æ–¹åˆ°è™•è·‘ï¼Œè·‘éæ±Ÿæ²³æ°´ç”Ÿæ³¢ï¼Œç©¿éæ£®æ—æ¨¹å‘¼å˜¯ã€‚", en: "Invisible, untouchable, runs everywhere, makes waves on rivers, makes trees roar.", ans: "é¢¨ (Wind)", opts: ["ç©ºæ°£ (Air)", "å…‰ (Light)", "é¢¨ (Wind)", "è²éŸ³ (Sound)"] },
            { cn: "å°ç™½èŠ±ï¼Œé£›æ»¿å¤©ï¼Œä¸‹åˆ°åœ°ä¸Šåƒç™½éºµï¼Œä¸‹åˆ°æ°´è£¡çœ‹ä¸è¦‹ã€‚", en: "Small white flowers flying in the sky, falls to the ground like white flour, disappears in water.", ans: "é›ª (Snow)", opts: ["é›¨ (Rain)", "é›ª (Snow)", "éœœ (Frost)", "é›² (Cloud)"] },
            { cn: "ç´…å½¤å½¤ï¼Œä¸€å¤§è“¬ï¼Œè¦‹é¢¨å®ƒå°±é€å…‡ç‹‚ï¼Œç„¡å˜´èƒ½åƒå¤©ä¸‹ç‰©ï¼Œå–®æ€•é›¨æ°´ä¸æ€•é¢¨ã€‚", en: "Red and fluffy, gets fierce in the wind, eats everything without a mouth, afraid of water but not wind.", ans: "ç« (Fire)", opts: ["æ°´ (Water)", "åœŸ (Earth)", "ç« (Fire)", "æœ¨ (Wood)"] },
            { cn: "å¤–é¢ç©¿ç¶ è¡£ï¼Œè£¡é¢ç´…ç“¤ç“¤ï¼Œé»‘é»‘å°ç±½ç±½ï¼Œå¤å¤©æœ€æ„›åƒã€‚", en: "Wears green outside, red inside, small black seeds, favorite in summer.", ans: "è¥¿ç“œ (Watermelon)", opts: ["è¥¿ç“œ (Watermelon)", "å“ˆå¯†ç“œ (Melon)", "è˜‹æœ (Apple)", "è‘¡è„ (Grape)"] },
            { cn: "ç™½ç³–æ¢…å­çœŸç¨€å¥‡ï¼Œä¹Ÿæ²’æ ¸å…’ä¹Ÿæ²’çš®ï¼Œè‚‰å…’è–„è–„å…¨å…œæ°´ï¼Œåªè¦ä¸€å£åƒåˆ°åº•ã€‚", en: "White sugar plum is rare, no pit and no skin, thin flesh holds water, eat it in one bite.", ans: "æ¹¯åœ“ (Tangyuan)", opts: ["æ°´é¤ƒ (Dumpling)", "åŒ…å­ (Baozi)", "æ¹¯åœ“ (Tangyuan)", "é¥…é ­ (Mantou)"] },
            { cn: "å¤–é¢ç™½èŒ«èŒ«ï¼Œè£¡é¢é»ƒæ¾„æ¾„ï¼Œç…®ç†Ÿè»Ÿç¶¿ç¶¿ï¼Œç‡Ÿé¤ŠçœŸè±å¯Œã€‚", en: "White outside, yellow inside, soft when boiled, very nutritious.", ans: "é›è›‹ (Egg)", opts: ["è±†è… (Tofu)", "é›è›‹ (Egg)", "é¦¬éˆ´è–¯ (Potato)", "èµ·å¸ (Cheese)"] },
            { cn: "å½å½åƒæœˆäº®ï¼Œé»ƒé»ƒåƒé¦™è•‰ï¼Œåƒåœ¨å˜´è£¡ç”œåˆé¦™ã€‚", en: "Curved like a moon, yellow like a banana, sweet and fragrant in the mouth.", ans: "é¦™è•‰ (Banana)", opts: ["èŠ’æœ (Mango)", "è˜‹æœ (Apple)", "æ©˜å­ (Orange)", "é¦™è•‰ (Banana)"] },
            { cn: "ç´…ç´…è‡‰è›‹åœ“åˆåœ“ï¼Œåƒåœ¨å˜´è£¡è„†åˆç”œã€‚", en: "Red face, round and round, crisp and sweet in the mouth.", ans: "è˜‹æœ (Apple)", opts: ["è‰è“ (Strawberry)", "æ«»æ¡ƒ (Cherry)", "è¥¿ç“œ (Watermelon)", "è˜‹æœ (Apple)"] },
            { cn: "å…©éš»å°èˆ¹ï¼Œæ²’æœ‰æœ¨é ­ï¼Œç™½å¤©åˆ°è™•èµ°ï¼Œæ™šä¸Šå®¢å»³ç•™ã€‚", en: "Two small boats, no wood, walk around by day, stay in the living room at night.", ans: "é‹å­ (Shoes)", opts: ["è¥ªå­ (Socks)", "å¸½å­ (Hat)", "æ‰‹å¥— (Gloves)", "é‹å­ (Shoes)"] },
            { cn: "ä¸€æœµèŠ±ï¼ŒçœŸå¥‡æ€ªï¼Œæ™´å¤©ä¸é–‹é›¨å¤©é–‹ã€‚", en: "A flower, very strange, blooms on rainy days not sunny days.", ans: "é›¨å‚˜ (Umbrella)", opts: ["é›¨è¡£ (Raincoat)", "é›¨é´ (Rain boots)", "å¸½å­ (Hat)", "é›¨å‚˜ (Umbrella)"] },
            { cn: "æœ‰çœ¼æ²’æœ‰ç ï¼Œæœ‰è…³ä¸èƒ½èµ°ï¼Œæœ‰èƒŒæ²’æœ‰è„Šï¼Œæœ‰è‚šæ²’æœ‰è…¸ã€‚", en: "Has eyes but no pupils, has legs but can't walk, has a back but no spine, has a belly but no intestines.", ans: "æ¤…å­ (Chair)", opts: ["æ¡Œå­ (Table)", "åºŠ (Bed)", "æ²™ç™¼ (Sofa)", "æ¤…å­ (Chair)"] },
            { cn: "å°–å°–å˜´ï¼Œç´°ç´°è…¿ï¼Œç‹¡çŒ¾å¤šç–‘è·‘å¾—å¿«ã€‚", en: "Pointy mouth, thin legs, cunning and suspicious, runs fast.", ans: "ç‹ç‹¸ (Fox)", opts: ["ç‹¼ (Wolf)", "ç‹— (Dog)", "è²“ (Cat)", "ç‹ç‹¸ (Fox)"] },
            { cn: "å¼Ÿå¼Ÿé•·ï¼Œå“¥å“¥çŸ­ï¼Œå…©äººè³½è·‘å¤§å®¶çœ‹ã€‚", en: "Younger brother is long, older brother is short, everyone watches them race.", ans: "æ™‚é˜ (Clock)", opts: ["æ‰‹éŒ¶ (Watch)", "æ™‚é˜ (Clock)", "æº«åº¦è¨ˆ (Thermometer)", "æŒ‡å—é‡ (Compass)"] },
            { cn: "å…„å¼Ÿå¹¾åå€‹ï¼Œåˆ†æˆå…©åŠåï¼Œæ¯å¤©æ—©ä¸Šä¾†ï¼Œå¹«ä½ æ´—ç™½ç™½ã€‚", en: "Dozens of brothers, split in two halves, come every morning to help you wash white.", ans: "ç‰™åˆ· (Toothbrush)", opts: ["ç‰™åˆ· (Toothbrush)", "æ¢³å­ (Comb)", "æ¯›å·¾ (Towel)", "è‚¥çš‚ (Soap)"] },
            { cn: "ä¸€æŠŠå°æ’éª¨ï¼Œæ²’æœ‰è‚‰å’Œè‚šï¼Œæ¯å¤©æ—©ä¸Šä¾†ï¼Œé ­ä¸Šè·³å€‹èˆã€‚", en: "A small row of ribs, no meat or belly, comes every morning to dance on your head.", ans: "æ¢³å­ (Comb)", opts: ["æ¢³å­ (Comb)", "ç‰™åˆ· (Toothbrush)", "å¤¾å­ (Clip)", "å‰ªåˆ€ (Scissors)"] },
            { cn: "ä½ ç¬‘ä»–ä¹Ÿç¬‘ï¼Œä½ å“­ä»–ä¹Ÿå“­ï¼Œä½ å•ä»–æ˜¯èª°ï¼Œä»–èªªä¸çŸ¥é“ã€‚", en: "You smile it smiles, you cry it cries, ask who it is, it says it doesn't know.", ans: "é¡å­ (Mirror)", opts: ["é¡å­ (Mirror)", "ç…§ç‰‡ (Photo)", "é›»è¦– (TV)", "çª—æˆ¶ (Window)"] },
            { cn: "å…«éš»è…³ï¼ŒæŠ¬é¢é¼“ï¼Œå…©æŠŠå‰ªåˆ€é¼“å‰èˆã€‚", en: "Eight legs, carrying a drum, two scissors dancing in front.", ans: "èƒèŸ¹ (Crab)", opts: ["èƒèŸ¹ (Crab)", "è¦å­ (Shrimp)", "çƒé¾œ (Turtle)", "é’è›™ (Frog)"] },
            { cn: "åå­—å«åšç‰›ï¼Œä¸æœƒæ‹‰çŠé ­ï¼Œèªªå®ƒåŠ›æ°£å°ï¼ŒèƒŒè‘—æˆ¿å­èµ°ã€‚", en: "Named a cow but can't pull a plow, said to be weak but carries a house walking.", ans: "è¸ç‰› (Snail)", opts: ["çƒé¾œ (Turtle)", "è¸ç‰› (Snail)", "æ¯›æ¯›èŸ² (Caterpillar)", "èèŸ» (Ant)"] },
            { cn: "å°æ™‚å€™æœ‰å°¾å·´ï¼Œé•·å¤§å¾Œå¤§å˜´å·´ï¼ŒæŠ“èŸ²å­æœ€å…§è¡Œï¼Œå‘±å‘±å‘±å«åª½åª½ã€‚", en: "Has a tail when young, big mouth when grown up, best at catching bugs, croaks mama.", ans: "é’è›™ (Frog)", opts: ["é’è›™ (Frog)", "èŸ¾èœ (Toad)", "é­š (Fish)", "é´¨å­ (Duck)"] },
            { cn: "é ­ä¸Šå…©æ ¹é¬šï¼Œèº«ç©¿èŠ±è¡£è¡«ï¼Œé£›åœ¨èŠ±å¢è£¡ï¼Œå¿«æ¨‚åˆç¾éº—ã€‚", en: "Two antennae on the head, wears colorful clothes, flies among the flowers, happy and beautiful.", ans: "è´è¶ (Butterfly)", opts: ["èœœèœ‚ (Bee)", "è´è¶ (Butterfly)", "èœ»èœ“ (Dragonfly)", "è’¼è … (Fly)"] },
            { cn: "ä¸æ˜¯é³¥å…’å¤©ä¸Šé£›ï¼Œä¸æ˜¯é­šå…’æµ·è£¡æ¸¸ï¼Œè‚šå­è£è‘—è¨±å¤šäººï¼Œå¸¶ä½ å‡ºåœ‹å»æ—…éŠã€‚", en: "Not a bird flying in the sky, not a fish swimming in the sea, belly full of people, takes you abroad to travel.", ans: "é£›æ©Ÿ (Airplane)", opts: ["ç†±æ°£çƒ (Hot air balloon)", "é£›æ©Ÿ (Airplane)", "ç›´å‡æ©Ÿ (Helicopter)", "ç«ç®­ (Rocket)"] },
            { cn: "åœ“åœ“èƒ–èƒ–è‚šå­å¤§ï¼Œè¡£æœäº”é¡å…­è‰²èŠ±ï¼Œåªè¦ä¸€æ ¹ç·šæ‹‰ä½ï¼Œå°±èƒ½é£„åˆ°å¤©ä¸Šå»ã€‚", en: "Round and fat big belly, colorful clothes, just hold it with a thread, and it can float to the sky.", ans: "æ°£çƒ (Balloon)", opts: ["é¢¨ç® (Kite)", "æ°£çƒ (Balloon)", "æ³¡æ³¡ (Bubble)", "é›² (Cloud)"] },
            { cn: "å…©æŠŠåˆ€ï¼Œäº¤å‰æŠ±ï¼Œå’¬ä¸€å£ï¼Œå¸ƒå°±æ‰ã€‚", en: "Two knives, crossed and hugged, take a bite, the cloth falls.", ans: "å‰ªåˆ€ (Scissors)", opts: ["åˆ€å­ (Knife)", "å‰ªåˆ€ (Scissors)", "é‰—å­ (Pliers)", "ç­·å­ (Chopsticks)"] }
        ];

        // ç³»çµ±ç‹€æ…‹
        const state = {
            view: 'welcome',
            user: { class: '', name: '', score: 0, answers: [] },
            participants: [],
            winners: JSON.parse(localStorage.getItem('lantern_winners') || '[]'), 
            riddles: [...BUILT_IN_RIDDLES], 
            activeRiddles: [], 
            gameStatus: 'loading',
            timer: null,
            isAdmin: false,
            TOTAL_QUESTIONS: 5 
        };

        // å–å¾—ç®¡ç†å“¡å¯†ç¢¼ (é è¨­ adminï¼Œå¯æ–¼å¾Œå°ä¿®æ”¹)
        function getAdminPwd() {
            return localStorage.getItem('admin_pwd') || 'admin';
        }

        // ğŸ› ï¸ å¯¦ç”¨å·¥å…·ï¼šé™£åˆ—æ´—ç‰Œ (Fisher-Yates Shuffle)
        function shuffleArray(array) {
            let curId = array.length;
            while (0 !== curId) {
                let randId = Math.floor(Math.random() * curId);
                curId -= 1;
                let tmp = array[curId];
                array[curId] = array[randId];
                array[randId] = tmp;
            }
            return array;
        }

        window.onload = () => {
            lucide.createIcons();
            router('welcome');
            fetchData();
            setInterval(fetchData, 5000); 
        };

        // è®€å–è³‡æ–™
        async function fetchData() {
            if(!GAS_API_URL.startsWith('http')) return;
            try {
                const res = await fetch(GAS_API_URL);
                const data = await res.json();
                state.gameStatus = data.status || 'idle';
                state.participants = data.participants || [];
                
                if(data.riddles && data.riddles.length >= 5) {
                    state.riddles = data.riddles;
                }
                
                updateStatusUI();
                if (state.view === 'dashboard') {
                    renderDashboardUI();
                }
                if (state.view === 'welcome') updateWelcomeButton();
                if (state.view === 'admin' && state.isAdmin) renderRiddleTable();
            } catch (e) {
                console.error("API Error", e);
                document.getElementById('status-text').innerText = "é€£ç·šå¤±æ•—";
            }
        }

        function updateStatusUI() {
            const badge = document.getElementById('status-badge');
            const text = document.getElementById('status-text');
            if(!text) return;
            text.textContent = state.gameStatus.toUpperCase();
            let color = 'bg-gray-600 text-gray-300';
            if (state.gameStatus === 'active') color = 'bg-green-500 text-white shadow-[0_0_10px_#22c55e]';
            if (state.gameStatus === 'paused') color = 'bg-yellow-500 text-black';
            badge.className = `px-3 py-1 rounded-full text-xs font-bold transition-colors flex items-center gap-2 ${color}`;
        }

        function router(viewName) {
            state.view = viewName;
            const container = document.getElementById('view-container');
            container.innerHTML = '';
            if (viewName === 'welcome') renderWelcome(container);
            else if (viewName === 'game') renderGame(container);
            else if (viewName === 'result') renderResult(container);
            else if (viewName === 'dashboard') renderDashboard(container);
            else if (viewName === 'admin') renderAdmin(container);
            lucide.createIcons();
        }

        // ==========================================
        // ğŸ  æ­¡è¿é  
        // ==========================================
        function renderWelcome(container) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center space-y-6 animate-fade-in w-full overflow-y-auto">
                    <h1 class="text-5xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 drop-shadow-sm leading-tight">
                        å…ƒå®µçŒœç‡ˆè¬<br>
                        <span class="text-3xl md:text-4xl">Lantern Festival Riddles</span>
                    </h1>
                    <p class="text-yellow-200 font-medium bg-black/30 px-4 py-2 rounded-full text-sm mt-2 border border-yellow-500/30">
                        å¾ 40 é¡Œä¸­éš¨æ©ŸæŠ½ 5 é¡Œ â€§ å…¨å°å³å¯ç²å¾—æŠ½çè³‡æ ¼ â€§ <span class="text-red-300">æ¯äººé™ç©ä¸€æ¬¡ï¼</span>
                    </p>
                    
                    <div class="w-full max-w-md bg-red-900/60 backdrop-blur-md border border-yellow-500/30 rounded-3xl p-8 shadow-2xl">
                        
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div class="col-span-1">
                                <label class="block text-yellow-400 text-sm font-bold mb-1 text-left">ç­ç´š / Class</label>
                                <input type="text" id="user-class" class="w-full p-3 rounded-xl bg-black/40 border border-yellow-600/30 text-white outline-none focus:border-yellow-400 transition" placeholder="ex: 301">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-yellow-400 text-sm font-bold mb-1 text-left">å§“å / Name</label>
                                <input type="text" id="user-name" class="w-full p-3 rounded-xl bg-black/40 border border-yellow-600/30 text-white outline-none focus:border-yellow-400 transition" placeholder="è«‹è¼¸å…¥å§“å...">
                            </div>
                        </div>
                        
                        <button id="start-btn" onclick="startGame()" class="w-full bg-gray-600 text-gray-400 font-bold text-xl py-4 rounded-xl flex items-center justify-center gap-2 cursor-not-allowed" disabled>
                            <i data-lucide="loader-2" class="animate-spin"></i> è¼‰å…¥ä¸­...
                        </button>
                    </div>
                </div>
            `;
            updateWelcomeButton();
        }

        function updateWelcomeButton() {
            const btn = document.getElementById('start-btn');
            if (!btn) return;
            if (state.gameStatus === 'active') {
                btn.disabled = false;
                btn.className = "w-full bg-gradient-to-r from-yellow-600 to-yellow-500 text-red-950 font-black text-xl py-4 rounded-xl shadow-lg hover:scale-105 transition cursor-pointer";
                btn.innerHTML = `<i data-lucide="play"></i> é–‹å§‹æŒ‘æˆ°`;
            } else {
                btn.disabled = true;
                btn.className = "w-full bg-gray-600 text-gray-400 font-bold text-xl py-4 rounded-xl flex items-center justify-center gap-2 cursor-not-allowed";
                btn.innerHTML = state.gameStatus === 'idle' ? 'æ´»å‹•æº–å‚™ä¸­' : 'æ´»å‹•æš«åœ/çµæŸ';
            }
            lucide.createIcons();
        }

        function startGame() {
            const cls = document.getElementById('user-class').value.trim();
            const name = document.getElementById('user-name').value.trim();
            if (!cls || !name) return alert('è«‹å®Œæ•´è¼¸å…¥ç­ç´šèˆ‡å§“åå–”ï¼');
            if (state.gameStatus !== 'active') return alert('æ´»å‹•å°šæœªé–‹å§‹');
            
            const hasPlayed = state.participants.some(p => p.class === cls && p.name === name);
            if (hasPlayed) {
                return alert('âš ï¸ æ‚¨å·²ç¶“åƒåŠ éå›‰ï¼æ¯å€‹äººåªèƒ½æŒ‘æˆ°ä¸€æ¬¡å–”ï¼');
            }

            state.user.class = cls;
            state.user.name = name;
            state.user.score = 0;
            state.user.answers = [];

            state.activeRiddles = shuffleArray([...state.riddles]).slice(0, state.TOTAL_QUESTIONS);
            router('game');
        }

        // ==========================================
        // ğŸ® éŠæˆ²é 
        // ==========================================
        let currentQIndex = 0;
        let timeLeft = 30;

        function renderGame(container) {
            currentQIndex = 0;
            showQuestion(container);
        }

        function showQuestion(container) {
            if (currentQIndex >= state.activeRiddles.length) {
                router('result');
                return;
            }
            
            const q = state.activeRiddles[currentQIndex];
            timeLeft = 30;
            const shuffledOptions = shuffleArray([...q.opts]);

            container.innerHTML = `
                <div class="max-w-md mx-auto h-full flex flex-col justify-center pb-10 w-full animate-fade-in">
                    <div class="flex justify-between items-center mb-6 bg-black/30 p-4 rounded-2xl border border-white/10">
                        <div class="flex items-center gap-2 text-yellow-400 font-mono text-2xl font-bold">
                            <i data-lucide="timer"></i> <span id="timer">${timeLeft}</span>
                        </div>
                        <div class="text-gray-400 font-mono text-lg">ç¬¬ ${currentQIndex + 1} é¡Œ / å…± ${state.TOTAL_QUESTIONS} é¡Œ</div>
                    </div>
                    
                    <div class="bg-white text-gray-900 rounded-[2rem] p-8 shadow-2xl mb-6 flex flex-col items-center text-center border-4 border-yellow-500 relative overflow-hidden min-h-[200px] justify-center">
                        <div class="absolute top-0 left-0 h-2 bg-gray-200 w-full">
                            <div id="progress-bar" class="h-full bg-green-500 transition-all duration-1000" style="width: 100%"></div>
                        </div>
                        <h3 class="text-2xl font-bold mb-4 text-red-900 leading-snug">${q.cn}</h3>
                        <p class="text-gray-500 font-medium text-sm border-t border-gray-100 pt-4 w-full">${q.en}</p>
                    </div>
                    
                    <div class="grid gap-3">
                        ${shuffledOptions.map((opt, i) => `
                            <button onclick="handleAnswer('${opt}')" class="w-full bg-red-900/40 hover:bg-yellow-500 hover:text-red-950 border border-yellow-500/30 text-white font-bold text-lg py-4 rounded-xl transition-all shadow-md backdrop-blur-sm flex items-center justify-between px-6">
                                <span class="flex items-center gap-3"><span class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-sm">${['A','B','C','D'][i]}</span>${opt}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            lucide.createIcons();
            
            if (state.timer) clearInterval(state.timer);
            state.timer = setInterval(() => {
                timeLeft--;
                const tEl = document.getElementById('timer');
                const pEl = document.getElementById('progress-bar');
                if(tEl) tEl.innerText = timeLeft;
                if(pEl) pEl.style.width = `${(timeLeft/30)*100}%`;
                if (timeLeft <= 0) { clearInterval(state.timer); handleAnswer(null); }
            }, 1000);
        }

        window.handleAnswer = function(ans) {
            clearInterval(state.timer);
            const q = state.activeRiddles[currentQIndex];
            if (ans === q.ans) state.user.score++;
            currentQIndex++;
            showQuestion(document.getElementById('view-container'));
        };

        // ==========================================
        // ğŸ† çµæœé 
        // ==========================================
        function renderResult(container) {
            submitScore();
            const isPerfect = state.user.score === state.TOTAL_QUESTIONS;
            let messageTitle = isPerfect ? "æ­å–œå…¨å°ï¼å¤ªæ£’äº†ï¼" : "æŒ‘æˆ°å®Œæˆï¼";
            let messageDesc = isPerfect ? 
                "<span class='text-green-400 font-bold'>ğŸ‰ æ‚¨å·²æˆåŠŸç²å¾—æŠ½çè³‡æ ¼ï¼</span>" : 
                `<span class='text-red-400 font-bold'>å¾ˆå¯æƒœ...å¿…é ˆ ${state.TOTAL_QUESTIONS} é¡Œå…¨å°æ‰èƒ½æŠ½çå–”ï¼</span>`;

            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center space-y-8 animate-fade-in">
                    <i data-lucide="${isPerfect ? 'award' : 'party-popper'}" class="text-yellow-400 w-24 h-24 animate-bounce"></i>
                    <div class="bg-red-900/60 backdrop-blur-md border border-yellow-500/50 p-10 rounded-3xl shadow-2xl w-full max-w-md">
                        <h2 class="text-3xl font-bold text-white mb-2">${messageTitle}</h2>
                        <div class="flex justify-center items-baseline gap-2 mb-4 bg-black/20 py-6 rounded-2xl mt-6">
                            <span class="text-7xl font-black ${isPerfect ? 'text-green-400' : 'text-yellow-400'}">${state.user.score}</span>
                            <span class="text-xl text-gray-500">/ ${state.TOTAL_QUESTIONS}</span>
                        </div>
                        <p class="mb-8">${messageDesc}</p>
                        <button onclick="router('dashboard')" class="w-full bg-white text-red-900 font-bold py-4 rounded-xl hover:bg-gray-100 shadow-lg flex items-center justify-center gap-2">
                            <i data-lucide="bar-chart-3"></i> æŸ¥çœ‹è‹±é›„æ¦œèˆ‡å¤§è¢å¹•
                        </button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function submitScore() {
            const time = Math.floor(Math.random() * 100) + 100;
            state.participants.push({
                class: state.user.class,
                name: state.user.name,
                score: state.user.score,
                time: time
            });
            fetch(GAS_API_URL, {
                method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'submit_score',
                    class: state.user.class,
                    name: state.user.name,
                    score: state.user.score,
                    time: time
                })
            });
        }

        // ==========================================
        // ğŸ“Š å¤§è¢å¹• Dashboard
        // ==========================================
        function renderDashboard(container) {
             // ğŸ¯ å‹•æ…‹ç”¢ç”ŸæŠ½çæŒ‰éˆ• (éœ€ç®¡ç†å“¡æ¬Šé™)
             const drawButtonHTML = state.isAdmin 
                ? `<button onclick="toggleDraw()" id="draw-btn" class="px-8 py-3 lg:px-10 lg:py-4 bg-gradient-to-r from-yellow-500 to-orange-500 text-red-900 text-xl lg:text-2xl font-bold rounded-full shadow-lg hover:scale-105 transition flex items-center gap-2">
                    <i data-lucide="sparkles"></i> é–‹å§‹æŠ½ç
                   </button>`
                : `<button onclick="alert('ğŸ”’ æ­¤åŠŸèƒ½å·²é–å®šï¼\\nè«‹å…ˆé»æ“Šå³ä¸Šè§’ã€Œå¾Œå°ã€ç™»å…¥ç®¡ç†è€…ï¼Œæ‰èƒ½é€²è¡ŒæŠ½çã€‚')" class="px-8 py-3 lg:px-10 lg:py-4 bg-gray-800/80 text-gray-400 text-lg lg:text-xl font-bold rounded-full shadow-lg border border-gray-600 transition flex items-center gap-2 hover:bg-gray-700 cursor-pointer">
                    <i data-lucide="lock"></i> æŠ½çå·²é–å®š (éœ€ç®¡ç†å“¡)
                   </button>`;

             const clearWinnersBtnHTML = state.isAdmin
                ? `<button onclick="clearWinners()" class="mt-4 w-full text-xs text-red-400 hover:text-white border border-red-900/50 hover:border-red-500 rounded p-2 transition hover:bg-red-900">ğŸ—‘ï¸ æ¸…ç©ºä¸­çåå–®</button>`
                : ``;

             container.innerHTML = `
                <div class="h-full flex flex-col gap-4 animate-fade-in pb-4">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="bg-yellow-500/20 p-4 rounded-xl flex items-center gap-3">
                            <div class="text-2xl font-bold font-mono text-white" id="stat-total">${state.participants.length}</div>
                            <div class="text-xs text-yellow-200/60 uppercase">äººåƒåŠ </div>
                        </div>
                        <div class="bg-green-500/20 p-4 rounded-xl flex items-center gap-3">
                            <div class="text-2xl font-bold font-mono text-green-400" id="stat-perfect">
                                ${state.participants.filter(p => p.score === state.TOTAL_QUESTIONS).length}
                            </div>
                            <div class="text-xs text-green-200/60 uppercase">äººå…¨å°</div>
                        </div>
                    </div>
                    
                    <!-- è¢å¹•ä¸‹åŠéƒ¨ï¼šæ’è¡Œæ¦œ(å·¦) / æŠ½çç•«é¢(ä¸­) / ä¸­çåå–®(å³) -->
                    <div class="flex-grow flex flex-col lg:flex-row gap-4 h-full overflow-hidden">
                        
                        <!-- å·¦ï¼šè‹±é›„æ¦œ Top 10 -->
                        <div class="w-full lg:w-1/4 bg-black/20 rounded-2xl p-4 flex flex-col border border-white/5 backdrop-blur-sm shadow-xl min-h-[250px]">
                            <h3 class="font-bold text-yellow-200 mb-4 flex items-center gap-2"><i data-lucide="crown"></i> è‹±é›„æ¦œ</h3>
                            <div id="leaderboard-list" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
                        </div>
                        
                        <!-- ä¸­ï¼šæŠ½çä¸»ç•«é¢ -->
                        <div class="w-full lg:w-2/4 bg-red-900/40 border border-yellow-500/30 rounded-2xl p-6 flex flex-col items-center justify-center relative shadow-2xl min-h-[300px]">
                             <h2 class="text-3xl lg:text-4xl font-black text-yellow-400 mb-2 tracking-widest text-center">LUCKY DRAW</h2>
                             <p class="text-gray-300 text-xs lg:text-sm mb-6 bg-black/30 px-4 py-1 rounded-full text-center">æ»¿åˆ†ä¸”å°šæœªä¸­çè€…</p>
                             
                             <div class="w-full max-w-md h-32 lg:h-48 bg-black/40 rounded-3xl flex items-center justify-center mb-6 lg:mb-8 border-2 border-yellow-500/30 shadow-[0_0_30px_rgba(234,179,8,0.2)]">
                                <div class="text-3xl md:text-5xl font-black text-white text-center px-4" id="winner-display">?</div>
                             </div>
                             
                             <!-- å‹•æ…‹è¼‰å…¥æŒ‰éˆ• -->
                             ${drawButtonHTML}
                        </div>

                        <!-- å³ï¼šä¸­çåå–® -->
                        <div class="w-full lg:w-1/4 bg-black/20 rounded-2xl p-4 flex flex-col border border-white/5 backdrop-blur-sm shadow-xl min-h-[250px]">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-green-400 flex items-center gap-2"><i data-lucide="gift"></i> ä¸­çå€</h3>
                                <span class="bg-green-600 text-white text-xs px-2 py-1 rounded-full" id="winner-count">0 äºº</span>
                            </div>
                            <div id="winners-list" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
                            ${clearWinnersBtnHTML}
                        </div>

                    </div>
                </div>
            `;
            renderDashboardUI();
        }

        function renderDashboardUI() {
            // æ›´æ–°ç‹€æ…‹åˆ—æ•¸å­—
            const totalEl = document.getElementById('stat-total');
            const perfectEl = document.getElementById('stat-perfect');
            if(totalEl) totalEl.innerText = state.participants.length;
            if(perfectEl) perfectEl.innerText = state.participants.filter(p => p.score === state.TOTAL_QUESTIONS).length;

            // ç¹ªè£½è‹±é›„æ¦œ
            const list = document.getElementById('leaderboard-list');
            if(list) {
                const sorted = [...state.participants].sort((a, b) => b.score - a.score || a.time - b.time);
                list.innerHTML = sorted.slice(0, 10).map((p, i) => `
                    <div class="flex items-center bg-white/5 p-2 rounded-lg text-sm border border-white/5 transition hover:bg-white/10">
                        <div class="w-6 h-6 rounded-full ${i<3 ? 'bg-yellow-500 text-red-900':'bg-gray-600 text-white'} flex items-center justify-center font-bold mr-3 text-xs">${i+1}</div>
                        <div class="flex-grow text-gray-200 font-bold truncate">${p.class} ${p.name}</div>
                        <div class="text-yellow-400 font-bold font-mono text-base">${p.score}</div>
                    </div>
                `).join('');
            }

            // ç¹ªè£½ä¸­çå€
            renderWinnersList();
        }

        let isRolling = false, drawInterval;
        let currentDrawUser = null;

        window.toggleDraw = function() {
            if (!state.isAdmin) return alert("è«‹å…ˆç™»å…¥ç®¡ç†å“¡æ‰èƒ½æŠ½çï¼");

            const display = document.getElementById('winner-display');
            const btn = document.getElementById('draw-btn');
            
            const candidates = state.participants.filter(p => 
                p.score === state.TOTAL_QUESTIONS && 
                !state.winners.some(w => w.class === p.class && w.name === p.name)
            );

            if(!candidates.length) return alert(`ç›®å‰æ²’æœ‰ç¬¦åˆæŠ½çè³‡æ ¼çš„ç©å®¶ï¼\n(å¯èƒ½å°šæœªæœ‰äººæ»¿åˆ†ï¼Œæˆ–æ‰€æœ‰æ»¿åˆ†è€…çš†å·²ä¸­ç)`);

            if(!isRolling) {
                isRolling = true;
                display.classList.remove('scale-110','text-yellow-300'); 
                btn.innerHTML = `<i data-lucide="stop-circle"></i> åœæ­¢ STOP`;
                btn.className = "px-10 py-4 bg-red-600 text-white text-xl lg:text-2xl font-bold rounded-full shadow-lg hover:scale-105 transition flex items-center gap-2 border-2 border-red-400";
                
                drawInterval = setInterval(() => {
                    currentDrawUser = candidates[Math.floor(Math.random()*candidates.length)];
                    display.innerText = `${currentDrawUser.class} ${currentDrawUser.name}`;
                }, 50);
            } else {
                isRolling = false;
                clearInterval(drawInterval);
                display.classList.add('scale-110','text-yellow-300', 'transition-transform');
                btn.innerHTML = `<i data-lucide="sparkles"></i> å†æ¬¡æŠ½ç`;
                btn.className = "px-10 py-4 bg-gradient-to-r from-yellow-500 to-orange-500 text-red-900 text-xl lg:text-2xl font-bold rounded-full shadow-lg hover:scale-105 transition flex items-center gap-2 border-2 border-yellow-400";
                
                if (currentDrawUser && !state.winners.some(w => w.class === currentDrawUser.class && w.name === currentDrawUser.name)) {
                    state.winners.push(currentDrawUser);
                    localStorage.setItem('lantern_winners', JSON.stringify(state.winners));
                    renderWinnersList();
                }
            }
            lucide.createIcons();
        }

        window.renderWinnersList = function() {
            const list = document.getElementById('winners-list');
            const countStr = document.getElementById('winner-count');
            if(!list) return;

            if(countStr) countStr.innerText = `${state.winners.length} äºº`;

            if(state.winners.length === 0) {
                list.innerHTML = `<div class="text-gray-400 text-sm text-center mt-8">å°šç„¡ä¸­çç´€éŒ„</div>`;
                return;
            }

            const reversedWinners = [...state.winners].reverse();
            list.innerHTML = reversedWinners.map((w, i) => `
                <div class="flex items-center bg-green-900/50 p-2 rounded-lg text-sm border border-green-500/30 animate-fade-in shadow-md">
                    <div class="w-6 h-6 rounded-full bg-green-500 text-white flex items-center justify-center font-bold mr-3 text-xs flex-shrink-0">
                        <i data-lucide="gift" class="w-3 h-3"></i>
                    </div>
                    <div class="flex-grow text-green-100 font-bold truncate">${w.class} ${w.name}</div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.clearWinners = function() {
            if (!state.isAdmin) return alert("è«‹å…ˆç™»å…¥ç®¡ç†å“¡æ‰èƒ½æ¸…ç©ºï¼");
            if(confirm("ç¢ºå®šè¦æ¸…ç©ºä¸­çåå–®å—ï¼Ÿ(æ³¨æ„ï¼šé€™å°‡æœƒæ¸…é™¤æ‚¨ç€è¦½å™¨ä¸­ç´€éŒ„çš„å¾—çè€…ï¼Œåå–®å…§çš„äººå°‡å¯ä»¥å†æ¬¡è¢«æŠ½ä¸­)")) {
                state.winners = [];
                localStorage.removeItem('lantern_winners'); 
                renderWinnersList();
            }
        }


        // ==========================================
        // âš™ï¸ å¾Œå° (é¡Œç›®ç®¡ç† + åŒ¯å‡º + ä¿®æ”¹å¯†ç¢¼åŠŸèƒ½)
        // ==========================================
        function renderAdmin(container) {
            if (!state.isAdmin) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full">
                        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-xs text-gray-800">
                            <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-red-900"><i data-lucide="lock"></i> ç®¡ç†è€…ç™»å…¥</h2>
                            <input type="password" id="admin-pwd" class="w-full border p-2 rounded mb-4 text-black outline-none focus:border-red-500" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
                            <button onclick="adminLogin()" class="w-full bg-red-800 text-white py-2 rounded font-bold hover:bg-red-700 transition">ç™»å…¥</button>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            container.innerHTML = `
                <div class="bg-white text-gray-800 p-6 rounded-3xl h-full shadow-xl flex flex-col overflow-hidden">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b">
                        <h2 class="text-xl font-bold text-red-900 flex items-center gap-2"><i data-lucide="settings"></i> ç®¡ç†ä¸­æ§å°</h2>
                        <button onclick="state.isAdmin=false;router('admin')" class="text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded transition">ç™»å‡º</button>
                    </div>

                    <div class="flex-grow overflow-y-auto pr-2 space-y-6 pb-6">
                        <section>
                            <h3 class="font-bold text-gray-600 mb-2 flex gap-2"><i data-lucide="toggle-left"></i> æ´»å‹•ç‹€æ…‹æ§åˆ¶</h3>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="updateStatus('idle')" class="p-3 rounded-lg border-2 border-yellow-200 bg-yellow-50 text-yellow-800 font-bold hover:bg-yellow-100 transition">æº–å‚™ä¸­</button>
                                <button onclick="updateStatus('active')" class="p-3 rounded-lg border-2 border-green-200 bg-green-50 text-green-800 font-bold hover:bg-green-100 transition">é€²è¡Œä¸­</button>
                                <button onclick="updateStatus('ended')" class="p-3 rounded-lg border-2 border-red-200 bg-red-50 text-red-800 font-bold hover:bg-red-100 transition">å·²çµæŸ</button>
                            </div>
                        </section>

                        <section>
                            <h3 class="font-bold text-gray-600 mb-2 flex gap-2"><i data-lucide="download"></i> æ•¸æ“šåŒ¯å‡ºèˆ‡ç®¡ç†</h3>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <button onclick="exportLeaderboard()" class="bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 flex items-center justify-center gap-2 transition shadow">
                                    <i data-lucide="file-spreadsheet"></i> åŒ¯å‡ºç¸½æˆç¸¾
                                </button>
                                <button onclick="exportPerfectScores()" class="bg-purple-600 text-white py-3 rounded-xl font-bold hover:bg-purple-700 flex items-center justify-center gap-2 transition shadow">
                                    <i data-lucide="award"></i> åŒ¯å‡ºæ»¿åˆ†åå–®
                                </button>
                            </div>
                            <button onclick="exportActualWinners()" class="w-full mb-3 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 flex items-center justify-center gap-2 transition shadow">
                                <i data-lucide="gift"></i> åŒ¯å‡ºã€Œå·²ä¸­çã€åå–®
                            </button>
                            <button onclick="clearData()" class="w-full border border-red-200 text-red-600 py-2 rounded-xl text-sm hover:bg-red-50 transition">ğŸ—‘ï¸ æ¸…ç©ºé›²ç«¯æ‰€æœ‰ç©å®¶æ•¸æ“š</button>
                        </section>

                        <section>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-gray-600 flex gap-2"><i data-lucide="book-open"></i> é¡Œåº«ç®¡ç† (${state.riddles.length}é¡Œ)</h3>
                                <div class="space-x-2">
                                    <button onclick="restoreDefaultRiddles()" class="bg-gray-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-gray-700 transition">é‚„åŸé è¨­ (${BUILT_IN_RIDDLES.length}é¡Œ)</button>
                                    <button onclick="addRiddle()" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-green-700 transition">+ æ–°å¢é¡Œç›®</button>
                                </div>
                            </div>
                            <div class="bg-gray-100 rounded-xl p-2 h-40 overflow-y-auto text-sm border border-gray-200 shadow-inner" id="riddle-list">
                                <!-- é¡Œç›®åˆ—è¡¨ -->
                            </div>
                        </section>

                        <!-- ğŸ” æ–°å¢å®‰å…¨è¨­å®šï¼šä¿®æ”¹å¯†ç¢¼ -->
                        <section class="pt-4 border-t border-gray-200">
                            <h3 class="font-bold text-gray-600 mb-2 flex gap-2"><i data-lucide="shield-check"></i> å®‰å…¨è¨­å®š (ä¿®æ”¹å¯†ç¢¼)</h3>
                            <div class="flex gap-2">
                                <input type="password" id="new-admin-pwd" class="flex-grow border border-gray-300 p-2 rounded-lg text-sm outline-none focus:border-red-500" placeholder="è¼¸å…¥æ–°çš„å¾Œå°å¯†ç¢¼">
                                <button onclick="changeAdminPassword()" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-700 transition shadow">æ›´æ–°å¯†ç¢¼</button>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">æç¤ºï¼šè‹¥æ‚¨çš„ Google Apps Script å¾Œç«¯è…³æœ¬æœ‰å¯«æ­»å¯†ç¢¼ï¼Œé€™è£¡æ›´æ”¹å¾Œå¯èƒ½å°è‡´åŒæ­¥å¤±æ•—ã€‚å»ºè­°å¾Œç«¯ä¸è¦æª¢æŸ¥å¯†ç¢¼ï¼Œæˆ–åŒæ­¥ä¿®æ”¹å¾Œç«¯è¨­å®šã€‚</p>
                        </section>
                    </div>
                </div>
            `;
            renderRiddleTable();
            lucide.createIcons();
        }

        window.adminLogin = function() {
            const p = document.getElementById('admin-pwd').value;
            if(p === getAdminPwd()) { 
                state.isAdmin = true; 
                router('admin'); 
            } else {
                alert('å¯†ç¢¼éŒ¯èª¤ï¼è«‹é‡è©¦ã€‚');
            }
        }

        window.changeAdminPassword = function() {
            const newPwd = document.getElementById('new-admin-pwd').value;
            if(!newPwd || newPwd.trim() === '') {
                return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ–°å¯†ç¢¼ï¼");
            }
            if(confirm("ç¢ºå®šè¦ä¿®æ”¹ç®¡ç†å“¡ç™»å…¥å¯†ç¢¼å—ï¼Ÿ")) {
                localStorage.setItem('admin_pwd', newPwd.trim());
                document.getElementById('new-admin-pwd').value = '';
                alert("âœ… å¯†ç¢¼å·²æˆåŠŸä¿®æ”¹ï¼ä¸‹æ¬¡ç™»å…¥è«‹ä½¿ç”¨æ–°å¯†ç¢¼ã€‚");
            }
        }

        function renderRiddleTable() {
            const list = document.getElementById('riddle-list');
            if(!list) return;
            if(state.riddles.length === 0) {
                list.innerHTML = `<div class="p-4 text-center text-gray-400">ç›®å‰æ²’æœ‰é¡Œç›®ï¼Œè«‹é»æ“Šä¸Šæ–¹æ–°å¢æˆ–é‚„åŸé è¨­ã€‚</div>`;
                return;
            }
            list.innerHTML = state.riddles.map((r, i) => `
                <div class="bg-white p-3 rounded-lg mb-2 shadow-sm border border-gray-200">
                    <div class="flex justify-between font-bold text-red-900 mb-1">
                        <span>Q${i+1}. ${r.cn}</span>
                        <button onclick="deleteRiddle(${i})" class="text-red-500 hover:bg-red-50 px-2 rounded transition">åˆªé™¤</button>
                    </div>
                    <div class="text-gray-500 text-xs mb-2">${r.en}</div>
                    <div class="grid grid-cols-4 gap-1 text-xs text-center text-gray-600">
                        ${r.opts.map(o => `<span class="${o===r.ans?'bg-green-100 text-green-700 font-bold border-green-200':''} border rounded py-1">${o}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        window.addRiddle = function() {
            const cn = prompt("ä¸­æ–‡é¡Œç›®:"); if(!cn) return;
            const en = prompt("è‹±æ–‡é¡Œç›® (å¯ç•™ç©º):") || " ";
            const ans = prompt("æ­£ç¢ºç­”æ¡ˆ:");
            const optsStr = prompt("å››å€‹é¸é … (è«‹ç”¨é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚: è˜‹æœ,é¦™è•‰,æ©˜å­,è‘¡è„):");
            if(!ans || !optsStr) return alert("è³‡æ–™ä¸å®Œæ•´");
            
            const opts = optsStr.split(/[,ï¼Œ]/).map(s=>s.trim());
            if(opts.length !== 4) return alert("è«‹è¼¸å…¥å‰›å¥½ 4 å€‹é¸é …ï¼Œä¸¦ç”¨é€—è™Ÿéš”é–‹");
            if(!opts.includes(ans)) return alert("æ‚¨è¨­å®šçš„å››å€‹é¸é …ä¸­ï¼Œå¿…é ˆåŒ…å«æ­£ç¢ºç­”æ¡ˆï¼");

            state.riddles.push({ id: Date.now(), cn, en, ans, opts });
            renderRiddleTable();
            saveRiddlesToBackend();
        }

        window.deleteRiddle = function(index) {
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤é¡Œï¼Ÿ")) return;
            state.riddles.splice(index, 1);
            renderRiddleTable();
            saveRiddlesToBackend();
        }

        window.restoreDefaultRiddles = function() {
            if(!confirm(`ç¢ºå®šé‚„åŸç‚ºé è¨­çš„ ${BUILT_IN_RIDDLES.length} é¡Œï¼Ÿé€™å°‡æœƒè¦†è“‹æ‚¨è‡ªè¨‚çš„é¡Œç›®ã€‚`)) return;
            state.riddles = [...BUILT_IN_RIDDLES];
            renderRiddleTable();
            saveRiddlesToBackend();
        }

        function saveRiddlesToBackend() {
            const tableData = state.riddles.map((r, idx) => [
                idx + 1, r.cn, r.en, r.ans, r.opts[0], r.opts[1], r.opts[2], r.opts[3]
            ]);

            fetch(GAS_API_URL, {
                method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'manage_riddle',
                    method: 'delete',
                    allRiddles: tableData,
                    password: getAdminPwd() // ğŸ” ä½¿ç”¨å‹•æ…‹å¯†ç¢¼
                })
            });
        }

        // ==========================================
        // åŒ¯å‡ºåŠŸèƒ½
        // ==========================================
        window.exportLeaderboard = function() {
            let csv = "\uFEFFClass,Name,Score,Time\n"; 
            const sorted = [...state.participants].sort((a,b) => b.score - a.score || a.time - b.time);
            sorted.forEach(p => { csv += `${p.class},${p.name},${p.score},${p.time}\n` });
            downloadCSV(csv, 'Lantern_Festival_All_Scores.csv');
        }

        window.exportPerfectScores = function() {
            let csv = "\uFEFFClass,Name,Score\n";
            const winners = state.participants.filter(p => p.score === state.TOTAL_QUESTIONS);
            winners.forEach(p => { csv += `${p.class},${p.name},${p.score}\n` });
            downloadCSV(csv, 'Lantern_Festival_Perfect_Scores.csv');
        }

        window.exportActualWinners = function() {
            if(state.winners.length === 0) return alert("ç›®å‰é‚„æ²’æœ‰äººä¸­çå–”ï¼");
            let csv = "\uFEFFNo.,Class,Name\n";
            state.winners.forEach((w, i) => { csv += `${i+1},${w.class},${w.name}\n` });
            downloadCSV(csv, 'Lantern_Festival_Actual_Winners.csv');
        }

        function downloadCSV(content, fileName) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            link.click();
            URL.revokeObjectURL(url);
        }

        window.updateStatus = function(s) {
            fetch(GAS_API_URL, {
                method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action: 'update_status', status: s, password: getAdminPwd() }) // ğŸ” ä½¿ç”¨å‹•æ…‹å¯†ç¢¼
            });
            state.gameStatus = s; 
            alert("ç‹€æ…‹åˆ‡æ›æŒ‡ä»¤å·²é€å‡ºï¼Œè«‹ç­‰å¾…åŒæ­¥ã€‚");
            updateStatusUI();
        }
        
        window.clearData = function() {
            if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰ç©å®¶æ•¸æ“šï¼Ÿ(æ³¨æ„ï¼šæ­¤æ“ä½œæœƒåˆªé™¤è©¦ç®—è¡¨ä¸Šçš„ç©å®¶ç´€éŒ„ï¼Œä¸å¯å¾©åŸï¼)")) {
                fetch(GAS_API_URL, {
                    method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'clear_data', password: getAdminPwd() }) // ğŸ” ä½¿ç”¨å‹•æ…‹å¯†ç¢¼
                });
                state.participants = [];
                state.winners = []; 
                localStorage.removeItem('lantern_winners'); 
                alert("å·²ç™¼é€æ¸…ç©ºæŒ‡ä»¤ï¼Œè©¦ç®—è¡¨è³‡æ–™å³å°‡æ¸…ç©ºã€‚");
            }
        }
    </script>
</body>
</html>